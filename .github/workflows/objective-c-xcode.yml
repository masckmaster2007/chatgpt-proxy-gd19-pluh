name: Build iOS armv7 dylib

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install build deps
      run: |
        sudo apt update
        sudo apt install -y cmake clang make perl python3 git unzip cpio libxml2-dev

    - name: Install osxcross
      run: |
        git clone https://github.com/tpoechtrager/osxcross.git
        cd osxcross
        mkdir -p tarballs
        wget -q https://github.com/xybp888/iOS-SDKs/releases/download/iOS-SDKs/iPhoneOS9.3.sdk.zip
        unzip -q iPhoneOS9.3.sdk.zip
        mv iPhoneOS9.3.sdk tarballs/
        touch tarballs/iPhoneOSX.sdk.tar.xz   # fake macOS SDK to satisfy bootstrap
        UNATTENDED=1 ./tools/get_dependencies.sh
        UNATTENDED=1 ./build.sh

    - name: Build dylib
      run: |
        export PATH="$HOME/osxcross/target/bin:$PATH"
        export SDK=iphoneos9.3

        o64-clang \
          -arch armv7 \
          -isysroot $OSXCROSS_TOP/target/SDK/$SDK.sdk \
          -miphoneos-version-min=5.0 \
          -framework Foundation \
          -framework Security \
          -dynamiclib gdproxy.m \
          -o libgdproxy.dylib

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gdproxy-armv7
        path: libgdproxy.dylib
