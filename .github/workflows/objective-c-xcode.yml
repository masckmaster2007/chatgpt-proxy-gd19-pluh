name: Build GDPS Proxy Dylib

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download curl headers
      run: |
        # Download curl source for headers only
        curl -L -o curl.tar.gz https://curl.se/download/curl-7.88.1.tar.gz
        tar -xzf curl.tar.gz
        mkdir -p /tmp/curl-headers
        cp -r curl-7.88.1/include/curl /tmp/curl-headers/
    
    - name: Build armv7 (32-bit)
      run: |
        clang \
          -arch armv7 \
          -miphoneos-version-min=5.0 \
          -dynamiclib \
          -o gdps_proxy_armv7.dylib \
          gdps_proxy.c \
          -I/tmp/curl-headers \
          -lcurl \
          -framework Security \
          -framework CoreFoundation \
          -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
          -target armv7-apple-ios5.0
    
    - name: Build arm64 (64-bit)
      run: |
        clang \
          -arch arm64 \
          -miphoneos-version-min=5.0 \
          -dynamiclib \
          -o gdps_proxy_arm64.dylib \
          gdps_proxy.c \
          -I/tmp/curl-headers \
          -lcurl \
          -framework Security \
          -framework CoreFoundation \
          -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
          -target arm64-apple-ios5.0
    
    - name: Create FAT binary
      run: |
        lipo -create \
          gdps_proxy_armv7.dylib \
          gdps_proxy_arm64.dylib \
          -output gdps_proxy.dylib
        
        # Verify it's a FAT binary
        lipo -info gdps_proxy.dylib
        file gdps_proxy.dylib
    
    - name: Code sign (optional, for testing)
      run: |
        codesign -f -s - gdps_proxy.dylib || true
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gdps-proxy-dylib
        path: |
          gdps_proxy.dylib
          gdps_proxy_armv7.dylib
          gdps_proxy_arm64.dylib
