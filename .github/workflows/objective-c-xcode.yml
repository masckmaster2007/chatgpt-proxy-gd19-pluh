name: Build iOS dylib

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    name: Build gdproxy dylib
    runs-on: macos-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Compile gdproxy.m into dylib
      run: |
        SDK=$(xcrun --sdk iphoneos --show-sdk-path)
        clang gdproxy.m \
            -isysroot "$SDK" \
            -arch armv7 \
            -mios-version-min=5.0 \
            -framework Foundation \
            -framework Security \
            -dynamiclib \
            -o libgdproxy.dylib

    - name: Verify output
      run: file libgdproxy.dylib

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gdproxy-dylib
        path: libgdproxy.dylib
