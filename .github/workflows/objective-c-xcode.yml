name: Build GDPS Proxy Dylib

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download iOS 9.3 SDK
      run: |
        curl -L -o iPhoneOS9.3.sdk.zip https://github.com/xybp888/iOS-SDKs/releases/download/iOS-SDKs/iPhoneOS9.3.sdk.zip
        unzip iPhoneOS9.3.sdk.zip
        sudo mkdir -p /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/
        sudo mv iPhoneOS9.3.sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/
    
    - name: Install build dependencies
      run: |
        brew install autoconf automake libtool
    
    - name: Build libcurl for iOS
      run: |
        # Clone curl source
        git clone https://github.com/curl/curl.git
        cd curl
        git checkout curl-8_4_0
        
        # Build for armv7
        ./buildconf
        export SDKROOT="/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS9.3.sdk"
        export CFLAGS="-arch armv7 -isysroot $SDKROOT -miphoneos-version-min=5.0"
        export LDFLAGS="-arch armv7 -isysroot $SDKROOT"
        ./configure --host=arm-apple-darwin --prefix=$PWD/armv7 --enable-static --disable-shared --with-secure-transport
        make -j$(sysctl -n hw.ncpu)
        make install
        make clean
        
        # Build for arm64
        export CFLAGS="-arch arm64 -isysroot $SDKROOT -miphoneos-version-min=5.0"
        export LDFLAGS="-arch arm64 -isysroot $SDKROOT"
        ./configure --host=aarch64-apple-darwin --prefix=$PWD/arm64 --enable-static --disable-shared --with-secure-transport
        make -j$(sysctl -n hw.ncpu)
        make install
        
        cd ..
    
    - name: Build armv7 (32-bit)
      run: |
        xcrun -sdk iphoneos9.3 clang -arch armv7 \
          -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS9.3.sdk \
          -miphoneos-version-min=5.0 \
          -dynamiclib \
          -o gdps_proxy_armv7.dylib \
          gdps_proxy.c \
          -framework Security \
          -framework CoreFoundation \
          -I./curl/armv7/include \
          ./curl/armv7/lib/libcurl.a
    
    - name: Build arm64 (64-bit)
      run: |
        xcrun -sdk iphoneos9.3 clang -arch arm64 \
          -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS9.3.sdk \
          -miphoneos-version-min=5.0 \
          -dynamiclib \
          -o gdps_proxy_arm64.dylib \
          gdps_proxy.c \
          -framework Security \
          -framework CoreFoundation \
          -I./curl/arm64/include \
          ./curl/arm64/lib/libcurl.a
    
    - name: Create FAT binary
      run: |
        lipo -create \
          gdps_proxy_armv7.dylib \
          gdps_proxy_arm64.dylib \
          -output gdps_proxy.dylib
        
        # Verify it's a FAT binary
        lipo -info gdps_proxy.dylib
        file gdps_proxy.dylib
    
    - name: Code sign (optional, for testing)
      run: |
        codesign -f -s - gdps_proxy.dylib || true
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gdps-proxy-dylib
        path: |
          gdps_proxy.dylib
          gdps_proxy_armv7.dylib
          gdps_proxy_arm64.dylib
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          gdps_proxy.dylib
          gdps_proxy_armv7.dylib
          gdps_proxy_arm64.dylib
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
